<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Details - COMMOTION.APP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        
        *, *::before, *::after { box-sizing: border-box; }
        html, body { overflow-x: hidden; max-width: 100vw; }
        
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f8f9fa;
        }
        
        .commotion-red { color: #b93a3a; }
        .bg-commotion-red { background-color: #b93a3a; }
        .hover-commotion-red:hover { background-color: #a02e2e; }
        .border-commotion-red { border-color: #b93a3a; }
        .logo-text { font-weight: 900; letter-spacing: -0.02em; }
        
        .tab-button { border-bottom: 2px solid transparent; }
        .tab-button.active { border-bottom-color: #b93a3a; color: #b93a3a; }
        
        .progress-bar { transition: width 0.5s ease; }
        .crew-card { transition: all 0.2s; }
        .crew-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center min-w-0">
                    <button onclick="window.location.href='dashboard.html'" class="mr-3 text-gray-500 hover:text-gray-700 p-2">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span class="text-lg sm:text-2xl logo-text commotion-red truncate">COMMOTION.APP</span>
                </div>
                <div class="flex items-center space-x-2 flex-shrink-0">
                    <span class="text-xs sm:text-sm text-gray-600 hidden sm:inline" id="userName">User</span>
                    <button onclick="logout()" class="text-gray-500 hover:text-gray-700 p-2">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-3 sm:px-6 lg:px-8 py-4 sm:py-8">
        
        <!-- Event Header -->
        <div class="bg-white rounded-xl shadow-sm p-4 sm:p-6 mb-6 border border-gray-100">
            <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center mb-4 gap-4">
                <div>
                    <div class="flex flex-wrap items-center gap-2 mb-2">
                        <h1 class="text-xl sm:text-3xl font-bold text-gray-900" id="eventName">Loading...</h1>
                        <span class="px-3 py-1 rounded-full text-xs sm:text-sm font-semibold" id="eventStatus">--</span>
                    </div>
                    <div class="flex flex-wrap gap-3 text-xs sm:text-sm text-gray-600">
                        <span><i class="fas fa-map-marker-alt commotion-red mr-1"></i><span id="eventLocation">--</span></span>
                        <span><i class="fas fa-calendar commotion-red mr-1"></i><span id="eventDates">--</span></span>
                        <span><i class="fas fa-users commotion-red mr-1"></i><span id="eventAttendees">--</span> attendees</span>
                    </div>
                </div>
                <div class="flex gap-2 w-full lg:w-auto" id="eventActions">
                    <!-- Buttons populated based on role -->
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mt-4" id="quickStats">
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-lg sm:text-2xl font-bold text-gray-900" id="budgetAmount">$0</p>
                    <p class="text-xs text-gray-600">Quote</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-lg sm:text-2xl font-bold text-green-600" id="paidAmount">$0</p>
                    <p class="text-xs text-gray-600">Paid</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-lg sm:text-2xl font-bold text-gray-900" id="crewCount">0</p>
                    <p class="text-xs text-gray-600">Crew</p>
                </div>
                <div class="text-center p-3 bg-gray-50 rounded-lg">
                    <p class="text-lg sm:text-2xl font-bold text-gray-900" id="gearValue">$0</p>
                    <p class="text-xs text-gray-600">Gear Value</p>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6">
            <div class="border-b border-gray-200 overflow-x-auto">
                <div class="flex px-4 sm:px-6 min-w-max" id="tabButtons">
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm active" onclick="switchTab('overview', this)">Overview</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500" onclick="switchTab('schedule', this)">Schedule</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500" onclick="switchTab('crew', this)">Crew</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500" onclick="switchTab('tasks', this)">Tasks</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500" onclick="switchTab('deliverables', this)">Deliverables</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500" onclick="switchTab('gear', this)">Gear</button>
                    <button class="tab-button py-3 sm:py-4 px-3 sm:px-4 font-semibold text-sm text-gray-500 admin-only hidden" onclick="switchTab('payments', this)">Payments</button>
                </div>
            </div>

            <div class="p-4 sm:p-6" id="tabContent">
                <!-- Tab content loads here -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4" onclick="if(event.target===this)closeEventModal()">
        <div id="eventModalContent" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"></div>
    </div>

    <script src="js/firebase-config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id') || 'evt-001';
        const userRole = localStorage.getItem('userRole') || 'admin';
        const userName = localStorage.getItem('userName') || 'User';
        
        // Check if logged in via localStorage (same as dashboard)
        if (!localStorage.getItem('userRole') || !localStorage.getItem('userName')) {
            window.location.href = 'index.html';
        }
        
        document.getElementById('userName').textContent = userName;

        // Global data storage
        let eventData = null;
        let crewData = [];
        let gearData = [];
        let clientsData = [];
        let tasksData = [];

        // Load all data from Firestore
        async function loadData() {
            try {
                // Load event
                eventData = await firestoreHelpers.getDoc('events', eventId);
                
                if (!eventData) {
                    document.getElementById('tabContent').innerHTML = '<div class="text-center py-12"><p class="text-red-600">Event not found: ' + eventId + '</p><a href="dashboard.html" class="text-blue-600 underline">Back to Dashboard</a></div>';
                    return;
                }
                
                // Load related data in parallel
                const [crew, gear, clients, tasks] = await Promise.all([
                    firestoreHelpers.getCollection('crew'),
                    firestoreHelpers.getCollection('gear'),
                    firestoreHelpers.getCollection('clients'),
                    firestoreHelpers.getCollection('tasks')
                ]);
                
                crewData = crew;
                gearData = gear;
                clientsData = clients;
                tasksData = tasks.filter(t => t.eventId === eventId);
                
                // Update header
                document.getElementById('eventName').textContent = eventData.name;
                document.getElementById('eventLocation').textContent = eventData.location;
                document.getElementById('eventDates').textContent = formatDateRange(eventData.startDate, eventData.endDate);
                document.getElementById('eventAttendees').textContent = eventData.attendees.toLocaleString();
                document.getElementById('budgetAmount').textContent = '$' + eventData.quoteAmount.toLocaleString();
                document.getElementById('paidAmount').textContent = '$' + eventData.paidAmount.toLocaleString();
                document.getElementById('crewCount').textContent = eventData.crewCount;
                document.getElementById('gearValue').textContent = '$' + eventData.gearValue.toLocaleString();
                
                const statusEl = document.getElementById('eventStatus');
                statusEl.textContent = getStatusLabel(eventData.status);
                statusEl.className = 'px-3 py-1 rounded-full text-xs sm:text-sm font-semibold ' + getStatusBadgeClass(eventData.status);
                
                document.title = eventData.name + ' - COMMOTION.APP';
                
                // Setup role-based UI
                setupRoleBasedUI();
                
                // Render initial tab
                renderTab();
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('tabContent').innerHTML = '<div class="text-center py-12"><p class="text-red-600">Error loading event data: ' + error.message + '</p><a href="dashboard.html" class="text-blue-600 underline">Back to Dashboard</a></div>';
            }
        }
        
        function setupRoleBasedUI() {
            const actionsDiv = document.getElementById('eventActions');
            
            if (userRole === 'admin') {
                // Show admin buttons
                actionsDiv.innerHTML = `
                    <button onclick="editEvent()" class="flex-1 lg:flex-none px-4 py-2 bg-commotion-red hover-commotion-red text-white rounded-lg text-sm font-semibold">
                        <i class="fas fa-edit mr-2"></i>Edit
                    </button>
                    <button onclick="exportEvent()" class="flex-1 lg:flex-none px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                    <button onclick="deleteEvent()" class="flex-1 lg:flex-none px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg text-sm font-semibold">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                `;
                // Show admin-only tabs
                document.querySelectorAll('.admin-only').forEach(el => el.classList.remove('hidden'));
            } else if (userRole === 'client') {
                // Clients can view but not edit most things
                actionsDiv.innerHTML = `
                    <button onclick="exportEvent()" class="flex-1 lg:flex-none px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-semibold">
                        <i class="fas fa-download mr-2"></i>Export
                    </button>
                `;
            } else {
                // Crew - view only
                actionsDiv.innerHTML = '';
            }
        }
        
        // Start loading immediately
        loadData();

        let currentTab = 'overview';

        function switchTab(tabName, clickedBtn) {
            currentTab = tabName;
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-gray-500');
            });
            clickedBtn.classList.add('active');
            clickedBtn.classList.remove('text-gray-500');
            renderTab();
        }

        function renderTab() {
            const container = document.getElementById('tabContent');
            switch(currentTab) {
                case 'overview': container.innerHTML = renderOverviewTab(); break;
                case 'schedule': container.innerHTML = renderScheduleTab(); break;
                case 'crew': container.innerHTML = renderCrewTab(); break;
                case 'tasks': container.innerHTML = renderTasksTab(); break;
                case 'deliverables': container.innerHTML = renderDeliverablesTab(); break;
                case 'gear': container.innerHTML = renderGearTab(); break;
                case 'payments': container.innerHTML = renderPaymentsTab(); break;
            }
        }

        function renderOverviewTab() {
            const client = clientsData.find(c => c.id === eventData.client_id) || {};
            const canEditNotes = userRole === 'admin' || userRole === 'client';
            const notes = eventData.eventNotes || [];
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-gray-50 rounded-lg p-4 sm:p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4"><i class="fas fa-building commotion-red mr-2"></i>Client</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Company:</span><span class="font-semibold">${client.company || eventData.clientName}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Contact:</span><span class="font-semibold">${client.contact || '--'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Email:</span><span class="font-semibold text-blue-600">${client.email || '--'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Phone:</span><span class="font-semibold">${client.phone || '--'}</span></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 sm:p-6">
                        <h3 class="text-lg font-bold text-gray-900 mb-4"><i class="fas fa-dollar-sign commotion-red mr-2"></i>Payment</h3>
                        <div class="mb-4">
                            <div class="flex justify-between text-sm mb-2"><span>Progress</span><span class="font-semibold">${Math.round(eventData.paidAmount / eventData.quoteAmount * 100)}%</span></div>
                            <div class="bg-gray-200 rounded-full h-3"><div class="bg-green-500 h-3 rounded-full progress-bar" style="width: ${eventData.paidAmount / eventData.quoteAmount * 100}%"></div></div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-gray-600">Quote:</span><span class="font-semibold">$${eventData.quoteAmount.toLocaleString()}</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Paid:</span><span class="text-green-600 font-semibold">$${eventData.paidAmount.toLocaleString()}</span></div>
                            <div class="flex justify-between border-t pt-2"><span class="font-semibold">Remaining:</span><span class="font-bold commotion-red">$${(eventData.quoteAmount - eventData.paidAmount).toLocaleString()}</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Legacy notes display -->
                ${eventData.notes ? `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 sm:p-6 mt-6"><h3 class="text-lg font-bold text-gray-900 mb-2"><i class="fas fa-info-circle text-yellow-600 mr-2"></i>Event Brief</h3><p class="text-sm text-gray-700">${eventData.notes}</p></div>` : ''}
                
                <!-- Notes section -->
                <div class="bg-white border border-gray-200 rounded-lg p-4 sm:p-6 mt-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-900"><i class="fas fa-sticky-note commotion-red mr-2"></i>Notes</h3>
                        ${canEditNotes ? `<button onclick="addNote()" class="text-sm text-red-600 hover:text-red-700 font-semibold"><i class="fas fa-plus mr-1"></i>Add Note</button>` : ''}
                    </div>
                    ${notes.length > 0 ? `
                        <div class="space-y-3">
                            ${notes.map((note, index) => `
                                <div class="bg-gray-50 rounded-lg p-3">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <p class="text-sm text-gray-700">${note.text}</p>
                                            <p class="text-xs text-gray-400 mt-1"><i class="fas fa-user mr-1"></i>${note.author} â€¢ ${new Date(note.date).toLocaleDateString('en-NZ', {day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'})}</p>
                                        </div>
                                        ${userRole === 'admin' ? `<button onclick="deleteNote(${index})" class="text-gray-400 hover:text-red-500 ml-2"><i class="fas fa-trash text-sm"></i></button>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-500 text-center py-4">No notes yet</p>'}
                </div>
            `;
        }

        function renderScheduleTab() {
            const canEdit = userRole === 'admin';
            
            if (!eventData.schedule || eventData.schedule.length === 0) {
                if (canEdit) {
                    return `<div class="text-center py-12 text-gray-500"><i class="fas fa-calendar-times text-4xl mb-3"></i><p>No schedule available</p><button onclick="addScheduleDay()" class="mt-4 px-4 py-2 bg-commotion-red text-white rounded-lg text-sm font-semibold">Create Schedule</button></div>`;
                }
                return `<div class="text-center py-12 text-gray-500"><i class="fas fa-calendar-times text-4xl mb-3"></i><p>No schedule available yet</p></div>`;
            }
            
            return `
                <div class="space-y-6">
                    ${eventData.schedule.map(day => `
                        <div class="border-l-4 border-red-200 pl-4">
                            <div class="flex justify-between items-center mb-3 ${canEdit ? 'cursor-pointer group' : ''}" ${canEdit ? `onclick="editScheduleDay('${day.date}')"` : ''}>
                                <h3 class="font-bold text-gray-900 ${canEdit ? 'group-hover:text-red-600' : ''}">${day.title}</h3>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">${new Date(day.date).toLocaleDateString('en-NZ', {weekday: 'short', month: 'short', day: 'numeric'})}</span>
                                    ${canEdit ? '<i class="fas fa-edit text-gray-400 group-hover:text-red-500"></i>' : ''}
                                </div>
                            </div>
                            <div class="space-y-2">
                                ${day.items.map(item => `
                                    <div class="flex items-start p-3 bg-gray-50 rounded-lg ${canEdit ? 'hover:bg-gray-100 cursor-pointer' : ''}" ${canEdit ? `onclick="editScheduleItem('${day.date}', '${item.time}')"` : ''}>
                                        <span class="text-sm font-semibold commotion-red w-14 flex-shrink-0">${item.time}</span>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900">${item.activity}</p>
                                            ${item.crew && item.crew.length > 0 ? `<p class="text-xs text-gray-500 mt-1 truncate"><i class="fas fa-users mr-1"></i>${item.crew.map(c => crewData.find(cr => cr.id === c)?.name || c).join(', ')}</p>` : ''}
                                        </div>
                                        ${canEdit ? '<i class="fas fa-edit text-gray-400 ml-2"></i>' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${canEdit ? `
                <div class="flex gap-3 mt-6">
                    <button onclick="addScheduleDay()" class="flex-1 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-calendar-plus mr-2"></i>Add Day</button>
                    <button onclick="addScheduleItem()" class="flex-1 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-plus mr-2"></i>Add Item</button>
                </div>
                ` : ''}
            `;
        }

        function renderCrewTab() {
            const canEdit = userRole === 'admin';
            const assignedCrew = eventData.crewAssigned ? eventData.crewAssigned.map(id => crewData.find(c => c.id === id)).filter(Boolean) : [];
            
            if (assignedCrew.length === 0) {
                if (canEdit) {
                    return `<div class="text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-3"></i><p>No crew assigned</p><button onclick="assignCrew()" class="mt-4 px-4 py-2 bg-commotion-red text-white rounded-lg text-sm font-semibold">Assign Crew</button></div>`;
                }
                return `<div class="text-center py-12 text-gray-500"><i class="fas fa-users text-4xl mb-3"></i><p>No crew assigned yet</p></div>`;
            }
            
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    ${assignedCrew.map(crew => `
                        <div class="crew-card bg-white border border-gray-200 rounded-xl p-4">
                            <div class="flex items-center mb-3">
                                <div class="w-12 h-12 rounded-full bg-commotion-red text-white flex items-center justify-center font-bold mr-3">${crew.name.split(' ').map(n => n[0]).join('')}</div>
                                <div>
                                    <h4 class="font-bold text-gray-900">${crew.name}</h4>
                                    <p class="text-sm text-gray-500">${crew.role}</p>
                                </div>
                            </div>
                            <div class="text-sm text-gray-600 space-y-1">
                                ${canEdit ? `<p><i class="fas fa-dollar-sign w-4 text-gray-400"></i> $${crew.rate}/day</p>` : ''}
                                <p><i class="fas fa-phone w-4 text-gray-400"></i> ${crew.phone}</p>
                                <p><i class="fas fa-envelope w-4 text-gray-400"></i> <a href="mailto:${crew.email}" class="text-blue-600 hover:underline">${crew.email}</a></p>
                            </div>
                            ${canEdit ? `<button onclick="viewCrewMember('${crew.id}')" class="w-full mt-3 px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-semibold">View Profile</button>` : ''}
                        </div>
                    `).join('')}
                </div>
                ${canEdit ? `<button onclick="assignCrew()" class="w-full mt-6 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-plus mr-2"></i>Add Crew Member</button>` : ''}
            `;
        }

        function renderTasksTab() {
            const canEdit = userRole === 'admin';
            const todoTasks = tasksData.filter(t => t.status === 'todo');
            const inProgressTasks = tasksData.filter(t => t.status === 'in-progress');
            const doneTasks = tasksData.filter(t => t.status === 'done');
            
            if (tasksData.length === 0 && !canEdit) {
                return `<div class="text-center py-12 text-gray-500"><i class="fas fa-tasks text-4xl mb-3"></i><p>No tasks assigned</p></div>`;
            }
            
            if (tasksData.length === 0 && canEdit) {
                return `<div class="text-center py-12 text-gray-500"><i class="fas fa-tasks text-4xl mb-3"></i><p>No tasks yet</p><button onclick="addTask()" class="mt-4 px-4 py-2 bg-commotion-red text-white rounded-lg text-sm font-semibold">Add Task</button></div>`;
            }
            
            return `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- TODO Column -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-bold text-gray-700 mb-3 flex items-center"><span class="w-3 h-3 bg-gray-400 rounded-full mr-2"></span>To Do (${todoTasks.length})</h4>
                        <div class="space-y-2">
                            ${todoTasks.map(task => renderTaskCard(task, canEdit)).join('')}
                        </div>
                    </div>
                    
                    <!-- In Progress Column -->
                    <div class="bg-yellow-50 rounded-lg p-4">
                        <h4 class="font-bold text-yellow-700 mb-3 flex items-center"><span class="w-3 h-3 bg-yellow-400 rounded-full mr-2"></span>In Progress (${inProgressTasks.length})</h4>
                        <div class="space-y-2">
                            ${inProgressTasks.map(task => renderTaskCard(task, canEdit)).join('')}
                        </div>
                    </div>
                    
                    <!-- Done Column -->
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-700 mb-3 flex items-center"><span class="w-3 h-3 bg-green-400 rounded-full mr-2"></span>Done (${doneTasks.length})</h4>
                        <div class="space-y-2">
                            ${doneTasks.map(task => renderTaskCard(task, canEdit)).join('')}
                        </div>
                    </div>
                </div>
                ${canEdit ? `<button onclick="addTask()" class="w-full mt-6 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-plus mr-2"></i>Add Task</button>` : ''}
            `;
        }
        
        function renderTaskCard(task, canEdit) {
            const assignedCrew = crewData.find(c => c.id === task.assignedTo);
            const priorityColors = { urgent: 'bg-red-100 text-red-700', high: 'bg-orange-100 text-orange-700', normal: 'bg-gray-100 text-gray-700' };
            
            return `
                <div class="bg-white rounded-lg p-3 shadow-sm border border-gray-200 ${canEdit ? 'cursor-pointer hover:shadow-md' : ''}" ${canEdit ? `onclick="editTask('${task.id}')"` : ''}>
                    <div class="flex justify-between items-start mb-2">
                        <h5 class="font-semibold text-sm text-gray-900 ${task.status === 'done' ? 'line-through text-gray-500' : ''}">${task.title}</h5>
                        ${task.priority ? `<span class="px-2 py-0.5 rounded text-xs font-semibold ${priorityColors[task.priority] || priorityColors.normal}">${task.priority}</span>` : ''}
                    </div>
                    ${task.description ? `<p class="text-xs text-gray-600 mb-2">${task.description}</p>` : ''}
                    <div class="flex justify-between items-center text-xs text-gray-500">
                        <span>${assignedCrew ? `<i class="fas fa-user mr-1"></i>${assignedCrew.name.split(' ')[0]}` : '<i class="fas fa-user-slash mr-1"></i>Unassigned'}</span>
                        <span><i class="fas fa-calendar mr-1"></i>${new Date(task.dueDate).toLocaleDateString('en-NZ', {month: 'short', day: 'numeric'})}</span>
                    </div>
                </div>
            `;
        }

        function renderDeliverablesTab() {
            const canEdit = userRole === 'admin';
            
            if (!eventData.deliverables || eventData.deliverables.length === 0) {
                if (canEdit) {
                    return `<div class="text-center py-12 text-gray-500"><i class="fas fa-film text-4xl mb-3"></i><p>No deliverables defined</p><button onclick="addDeliverable()" class="mt-4 px-4 py-2 bg-commotion-red text-white rounded-lg text-sm font-semibold">Add Deliverable</button></div>`;
                }
                return `<div class="text-center py-12 text-gray-500"><i class="fas fa-film text-4xl mb-3"></i><p>No deliverables defined yet</p></div>`;
            }
            
            return `
                <div class="space-y-4">
                    ${eventData.deliverables.map(d => `
                        <div class="bg-white border border-gray-200 rounded-xl p-4 sm:p-6">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                                <div>
                                    <h4 class="font-bold text-gray-900">${d.type}</h4>
                                    <p class="text-sm text-gray-500">Duration: ${d.duration}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${getStatusBadgeClass(d.status)}">${getStatusLabel(d.status)}</span>
                                    ${canEdit ? `<button onclick="editDeliverable('${d.id}')" class="p-2 text-gray-400 hover:text-gray-600"><i class="fas fa-edit"></i></button>` : ''}
                                </div>
                            </div>
                            <div class="mb-2">
                                <div class="flex justify-between text-xs text-gray-500 mb-1"><span>Progress</span><span>${d.progress || 0}%</span></div>
                                <div class="bg-gray-200 rounded-full h-2"><div class="bg-commotion-red h-2 rounded-full progress-bar" style="width: ${d.progress || 0}%"></div></div>
                            </div>
                            <div class="flex justify-between items-center">
                                <p class="text-xs text-gray-500"><i class="fas fa-calendar mr-1"></i>Due: ${new Date(d.dueDate).toLocaleDateString('en-NZ', {month: 'short', day: 'numeric', year: 'numeric'})}</p>
                                ${d.accessLink ? `<a href="${d.accessLink}" target="_blank" class="text-xs text-blue-600 hover:underline"><i class="fas fa-external-link-alt mr-1"></i>View Deliverable</a>` : (d.status === 'completed' && canEdit ? `<button onclick="addDeliverableLink('${d.id}')" class="text-xs text-blue-600 hover:underline"><i class="fas fa-link mr-1"></i>Add Link</button>` : '')}
                            </div>
                        </div>
                    `).join('')}
                </div>
                ${canEdit ? `<button onclick="addDeliverable()" class="w-full mt-6 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-plus mr-2"></i>Add Deliverable</button>` : ''}
            `;
        }

        function renderGearTab() {
            const canEdit = userRole === 'admin';
            const assignedGear = gearData.filter(g => g.assignedTo === eventId);
            
            return `
                <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-semibold text-gray-900">Total Insurance Value:</span>
                        <span class="text-xl font-bold commotion-red">$${eventData.gearValue.toLocaleString()}</span>
                    </div>
                </div>
                ${assignedGear.length > 0 ? `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        ${assignedGear.map(gear => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h4 class="font-semibold text-gray-900">${gear.name}</h4>
                                        <p class="text-sm text-gray-500">${gear.category}</p>
                                    </div>
                                    <span class="px-2 py-1 bg-red-100 text-red-700 text-xs font-semibold rounded-full">Assigned</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    <p>Value: <span class="font-semibold">$${gear.value.toLocaleString()}</span></p>
                                    <p>Owner: <span class="font-semibold ${gear.ownerId === 'commotion' ? 'commotion-red' : 'text-blue-600'}">${gear.owner}</span></p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<div class="text-center py-8 text-gray-500"><p>No gear specifically assigned to this event</p></div>'}
                ${canEdit ? `<button onclick="assignGear()" class="w-full mt-6 px-4 py-3 border-2 border-dashed border-gray-300 text-gray-600 rounded-lg hover:border-red-500 hover:text-red-600"><i class="fas fa-plus mr-2"></i>Assign Gear</button>` : ''}
            `;
        }

        // Action functions
        function editEvent() {
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-edit mr-2 commotion-red"></i>Edit Event</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleSaveEvent(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Event Name</label>
                            <input type="text" id="editEventName" value="${eventData.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                                <input type="date" id="editEventStart" value="${eventData.startDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                                <input type="date" id="editEventEnd" value="${eventData.endDate}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                            <input type="text" id="editEventLocation" value="${eventData.location}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Attendees</label>
                                <input type="number" id="editEventAttendees" value="${eventData.attendees}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="editEventStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="lead" ${eventData.status === 'lead' ? 'selected' : ''}>Lead</option>
                                    <option value="quote-sent" ${eventData.status === 'quote-sent' ? 'selected' : ''}>Quote Sent</option>
                                    <option value="confirmed" ${eventData.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="in-progress" ${eventData.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="completed" ${eventData.status === 'completed' ? 'selected' : ''}>Completed</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quote Amount ($)</label>
                                <input type="number" id="editEventQuote" value="${eventData.quoteAmount}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Paid Amount ($)</label>
                                <input type="number" id="editEventPaid" value="${eventData.paidAmount}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                            <textarea id="editEventNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${eventData.notes || ''}</textarea>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="saveEventBtn" class="flex-1 px-4 py-3 bg-commotion-red hover-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleSaveEvent(e) {
            e.preventDefault();
            const btn = document.getElementById('saveEventBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const updates = {
                name: document.getElementById('editEventName').value,
                startDate: document.getElementById('editEventStart').value,
                endDate: document.getElementById('editEventEnd').value,
                location: document.getElementById('editEventLocation').value,
                attendees: parseInt(document.getElementById('editEventAttendees').value),
                status: document.getElementById('editEventStatus').value,
                quoteAmount: parseInt(document.getElementById('editEventQuote').value),
                paidAmount: parseInt(document.getElementById('editEventPaid').value),
                notes: document.getElementById('editEventNotes').value
            };
            
            const result = await firestoreHelpers.updateDoc('events', eventId, updates);
            
            if (result.success) {
                closeEventModal();
                // Reload data to show changes
                await loadData();
            } else {
                alert('Error saving changes: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        function exportEvent() { 
            // Generate a simple text export
            const exportData = `
EVENT DETAILS
=============
Name: ${eventData.name}
Location: ${eventData.location}
Dates: ${formatDateRange(eventData.startDate, eventData.endDate)}
Status: ${getStatusLabel(eventData.status)}
Attendees: ${eventData.attendees.toLocaleString()}

FINANCIALS
----------
Quote: $${eventData.quoteAmount.toLocaleString()}
Paid: $${eventData.paidAmount.toLocaleString()}
Remaining: $${(eventData.quoteAmount - eventData.paidAmount).toLocaleString()}

CREW (${eventData.crewCount})
----
${eventData.crewAssigned ? eventData.crewAssigned.map(id => {
    const c = crewData.find(cr => cr.id === id);
    return c ? `- ${c.name} (${c.role})` : '';
}).filter(Boolean).join('\n') : 'No crew assigned'}

NOTES
-----
${eventData.notes || 'No notes'}
            `.trim();
            
            const blob = new Blob([exportData], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${eventData.name.replace(/\s+/g, '_')}_export.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function addScheduleDay() { 
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-calendar-plus mr-2 commotion-red"></i>Add Schedule Day</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAddScheduleDay(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                            <input type="date" id="newDayDate" min="${eventData.startDate}" max="${eventData.endDate}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day Title</label>
                            <input type="text" id="newDayTitle" placeholder="e.g., Day 1 - Setup" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="addDayBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Add Day</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAddScheduleDay(e) {
            e.preventDefault();
            const btn = document.getElementById('addDayBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            const newDay = {
                date: document.getElementById('newDayDate').value,
                title: document.getElementById('newDayTitle').value,
                items: []
            };
            
            const schedule = eventData.schedule || [];
            schedule.push(newDay);
            schedule.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error adding schedule day: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Add Day';
            }
        }
        
        function editScheduleDay(date) {
            const day = eventData.schedule.find(d => d.date === date);
            if (!day) return;
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-calendar-day mr-2 commotion-red"></i>Edit Schedule Day</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleEditScheduleDay(event, '${date}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day Title</label>
                            <input type="text" id="editDayTitle" value="${day.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="editDayBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="handleDeleteScheduleDay('${date}')" class="px-4 py-3 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg font-semibold">Delete Day</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleEditScheduleDay(e, date) {
            e.preventDefault();
            const btn = document.getElementById('editDayBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const schedule = eventData.schedule.map(day => {
                if (day.date === date) {
                    return { ...day, title: document.getElementById('editDayTitle').value };
                }
                return day;
            });
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error updating schedule day: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function handleDeleteScheduleDay(date) {
            const schedule = eventData.schedule.filter(day => day.date !== date);
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error deleting schedule day: ' + result.error);
            }
        }
        
        function addScheduleItem() { 
            const days = eventData.schedule || [];
            if (days.length === 0) {
                alert('Please add a schedule day first');
                return;
            }
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-clock mr-2 commotion-red"></i>Add Schedule Item</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAddScheduleItem(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Day</label>
                            <select id="itemDay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                ${days.map(d => `<option value="${d.date}">${d.title} (${d.date})</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <input type="time" id="itemTime" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Activity</label>
                            <input type="text" id="itemActivity" placeholder="e.g., Main stage coverage" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Crew</label>
                            <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                ${(eventData.crewAssigned || []).map(id => {
                                    const c = crewData.find(cr => cr.id === id);
                                    return c ? `<label class="flex items-center"><input type="checkbox" value="${c.id}" class="item-crew-checkbox mr-2"> ${c.name}</label>` : '';
                                }).join('')}
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="addItemBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Add Item</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAddScheduleItem(e) {
            e.preventDefault();
            const btn = document.getElementById('addItemBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            const selectedCrew = Array.from(document.querySelectorAll('.item-crew-checkbox:checked')).map(cb => cb.value);
            const dayDate = document.getElementById('itemDay').value;
            const time = document.getElementById('itemTime').value;
            const timeFormatted = time.replace(':', '');
            const displayTime = new Date('2000-01-01T' + time).toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const newItem = {
                time: displayTime,
                activity: document.getElementById('itemActivity').value,
                crew: selectedCrew
            };
            
            const schedule = eventData.schedule.map(day => {
                if (day.date === dayDate) {
                    day.items = [...(day.items || []), newItem].sort((a, b) => a.time.localeCompare(b.time));
                }
                return day;
            });
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error adding schedule item: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Add Item';
            }
        }
        
        function editScheduleItem(date, time) { 
            const day = eventData.schedule.find(d => d.date === date);
            const item = day?.items.find(i => i.time === time);
            if (!item) return;
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-edit mr-2 commotion-red"></i>Edit Schedule Item</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleEditScheduleItem(event, '${date}', '${time}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                            <input type="time" id="editItemTime" value="${time.replace(':', '')}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Activity</label>
                            <input type="text" id="editItemActivity" value="${item.activity}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Assigned Crew</label>
                            <div class="space-y-2 max-h-32 overflow-y-auto border border-gray-200 rounded-lg p-2">
                                ${(eventData.crewAssigned || []).map(id => {
                                    const c = crewData.find(cr => cr.id === id);
                                    const checked = (item.crew || []).includes(id) ? 'checked' : '';
                                    return c ? `<label class="flex items-center"><input type="checkbox" value="${c.id}" ${checked} class="edit-crew-checkbox mr-2"> ${c.name}</label>` : '';
                                }).join('')}
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="editItemBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="handleDeleteScheduleItem('${date}', '${time}')" class="px-4 py-3 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg font-semibold">Delete</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleEditScheduleItem(e, date, oldTime) {
            e.preventDefault();
            const btn = document.getElementById('editItemBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const selectedCrew = Array.from(document.querySelectorAll('.edit-crew-checkbox:checked')).map(cb => cb.value);
            const time = document.getElementById('editItemTime').value;
            const displayTime = new Date('2000-01-01T' + time).toLocaleTimeString('en-NZ', { hour: '2-digit', minute: '2-digit', hour12: false });
            
            const schedule = eventData.schedule.map(day => {
                if (day.date === date) {
                    day.items = day.items.map(item => {
                        if (item.time === oldTime) {
                            return {
                                time: displayTime,
                                activity: document.getElementById('editItemActivity').value,
                                crew: selectedCrew
                            };
                        }
                        return item;
                    }).sort((a, b) => a.time.localeCompare(b.time));
                }
                return day;
            });
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error updating schedule item: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function handleDeleteScheduleItem(date, time) {
            if (!confirm('Delete this schedule item?')) return;
            
            const schedule = eventData.schedule.map(day => {
                if (day.date === date) {
                    day.items = day.items.filter(item => item.time !== time);
                }
                return day;
            });
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { schedule });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error deleting schedule item: ' + result.error);
            }
        }
        
        function assignCrew() { 
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            const assigned = eventData.crewAssigned || [];
            
            // Sort crew: assigned first, then available, then unavailable
            const sortedCrew = [...crewData].sort((a, b) => {
                const aAssigned = assigned.includes(a.id);
                const bAssigned = assigned.includes(b.id);
                if (aAssigned && !bAssigned) return -1;
                if (!aAssigned && bAssigned) return 1;
                if (a.available && !b.available) return -1;
                if (!a.available && b.available) return 1;
                return a.name.localeCompare(b.name);
            });
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-users mr-2 commotion-red"></i>Manage Crew</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <p class="text-sm text-gray-600 mb-4">Check crew to assign, uncheck to remove from this event.</p>
                    <form onsubmit="handleAssignCrew(event)" class="space-y-4">
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${sortedCrew.map(c => `
                                <label class="flex items-center p-3 ${assigned.includes(c.id) ? 'bg-green-50 border border-green-200' : 'bg-gray-50'} rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <input type="checkbox" value="${c.id}" ${assigned.includes(c.id) ? 'checked' : ''} class="assign-crew-checkbox mr-3">
                                    <div class="flex-1">
                                        <span class="font-semibold">${c.name}</span>
                                        <span class="text-gray-500 text-sm ml-2">${c.role}</span>
                                    </div>
                                    <span class="text-sm text-gray-500">$${c.rate}/day</span>
                                    ${c.available ? '<span class="ml-2 w-2 h-2 bg-green-500 rounded-full"></span>' : '<span class="ml-2 w-2 h-2 bg-red-500 rounded-full"></span>'}
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="assignCrewBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAssignCrew(e) {
            e.preventDefault();
            const btn = document.getElementById('assignCrewBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const selectedCrew = Array.from(document.querySelectorAll('.assign-crew-checkbox:checked')).map(cb => cb.value);
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { 
                crewAssigned: selectedCrew,
                crewCount: selectedCrew.length
            });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error assigning crew: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Assignments';
            }
        }
        
        function viewCrewMember(id) { 
            const crew = crewData.find(c => c.id === id);
            if (!crew) return;
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-user mr-2 commotion-red"></i>Crew Profile</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <div class="text-center mb-6">
                        <div class="w-20 h-20 rounded-full bg-commotion-red text-white flex items-center justify-center text-2xl font-bold mx-auto mb-3">
                            ${crew.name.split(' ').map(n => n[0]).join('')}
                        </div>
                        <h3 class="text-xl font-bold">${crew.name}</h3>
                        <p class="text-gray-500">${crew.role}</p>
                    </div>
                    <div class="space-y-3 bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between"><span class="text-gray-600">Day Rate:</span><span class="font-semibold">$${crew.rate}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Phone:</span><span class="font-semibold">${crew.phone}</span></div>
                        <div class="flex justify-between"><span class="text-gray-600">Email:</span><a href="mailto:${crew.email}" class="font-semibold text-blue-600">${crew.email}</a></div>
                        <div class="flex justify-between"><span class="text-gray-600">Status:</span><span class="font-semibold ${crew.available ? 'text-green-600' : 'text-red-600'}">${crew.available ? 'Available' : 'Unavailable'}</span></div>
                        ${crew.skills ? `<div class="pt-2 border-t"><span class="text-gray-600 text-sm">Skills:</span><div class="flex flex-wrap gap-1 mt-1">${crew.skills.map(s => `<span class="px-2 py-1 bg-gray-200 text-gray-700 text-xs rounded-full">${s}</span>`).join('')}</div></div>` : ''}
                    </div>
                    <button onclick="closeEventModal()" class="w-full mt-6 px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Close</button>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function addDeliverable() { 
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-film mr-2 commotion-red"></i>Add Deliverable</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAddDeliverable(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <select id="delType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="Highlight Reel">Highlight Reel</option>
                                <option value="After Movie">After Movie</option>
                                <option value="Social Media Package">Social Media Package</option>
                                <option value="Full Coverage">Full Coverage</option>
                                <option value="Artist Interviews">Artist Interviews</option>
                                <option value="Documentary">Documentary</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration/Details</label>
                            <input type="text" id="delDuration" placeholder="e.g., 3-5 min, 10x clips" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="delDueDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="addDelBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Add Deliverable</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAddDeliverable(e) {
            e.preventDefault();
            const btn = document.getElementById('addDelBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            const newDeliverable = {
                id: 'del-' + Date.now(),
                type: document.getElementById('delType').value,
                duration: document.getElementById('delDuration').value,
                dueDate: document.getElementById('delDueDate').value,
                status: 'pending',
                progress: 0
            };
            
            const deliverables = [...(eventData.deliverables || []), newDeliverable];
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { deliverables });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error adding deliverable: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Add Deliverable';
            }
        }
        
        function editDeliverable(id) { 
            const del = eventData.deliverables.find(d => d.id === id);
            if (!del) return;
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-edit mr-2 commotion-red"></i>Edit Deliverable</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleEditDeliverable(event, '${id}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                            <input type="text" id="editDelType" value="${del.type}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Duration/Details</label>
                            <input type="text" id="editDelDuration" value="${del.duration}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                            <input type="date" id="editDelDueDate" value="${del.dueDate}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="editDelStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="pending" ${del.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="in-progress" ${del.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="completed" ${del.status === 'completed' ? 'selected' : ''}>Completed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Progress: <span id="progressLabel">${del.progress || 0}%</span></label>
                            <input type="range" id="editDelProgress" min="0" max="100" value="${del.progress || 0}" oninput="document.getElementById('progressLabel').textContent = this.value + '%'" class="w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Access Link (for client viewing)</label>
                            <input type="url" id="editDelAccessLink" value="${del.accessLink || ''}" placeholder="https://drive.google.com/..." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <p class="text-xs text-gray-500 mt-1">Add a link where client can view/download the final deliverable</p>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="editDelBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="handleDeleteDeliverable('${id}')" class="px-4 py-3 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg font-semibold">Delete</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        function addDeliverableLink(id) {
            const link = prompt('Enter the access link for this deliverable (e.g., Google Drive, Dropbox link):');
            if (link) {
                const deliverables = eventData.deliverables.map(d => {
                    if (d.id === id) {
                        return { ...d, accessLink: link };
                    }
                    return d;
                });
                firestoreHelpers.updateDoc('events', eventId, { deliverables }).then(() => loadData());
            }
        }
        
        async function handleEditDeliverable(e, id) {
            e.preventDefault();
            const btn = document.getElementById('editDelBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const deliverables = eventData.deliverables.map(d => {
                if (d.id === id) {
                    return {
                        ...d,
                        type: document.getElementById('editDelType').value,
                        duration: document.getElementById('editDelDuration').value,
                        dueDate: document.getElementById('editDelDueDate').value,
                        status: document.getElementById('editDelStatus').value,
                        progress: parseInt(document.getElementById('editDelProgress').value),
                        accessLink: document.getElementById('editDelAccessLink').value || null
                    };
                }
                return d;
            });
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { deliverables });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error updating deliverable: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function handleDeleteDeliverable(id) {
            const deliverables = eventData.deliverables.filter(d => d.id !== id);
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { deliverables });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error deleting deliverable: ' + result.error);
            }
        }
        
        function assignGear() { 
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            const availableGear = gearData.filter(g => g.status === 'available' || g.assignedTo === eventId);
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-camera mr-2 commotion-red"></i>Assign Gear</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAssignGear(event)" class="space-y-4">
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${availableGear.map(g => `
                                <label class="flex items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer">
                                    <input type="checkbox" value="${g.id}" ${g.assignedTo === eventId ? 'checked' : ''} class="assign-gear-checkbox mr-3">
                                    <div class="flex-1">
                                        <span class="font-semibold">${g.name}</span>
                                        <span class="text-gray-500 text-sm ml-2">${g.category}</span>
                                    </div>
                                    <span class="text-sm font-semibold">$${g.value.toLocaleString()}</span>
                                </label>
                            `).join('')}
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="assignGearBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Assignments</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAssignGear(e) {
            e.preventDefault();
            const btn = document.getElementById('assignGearBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const selectedGearIds = Array.from(document.querySelectorAll('.assign-gear-checkbox:checked')).map(cb => cb.value);
            
            // Update each gear item
            let totalValue = 0;
            for (const gear of gearData) {
                if (selectedGearIds.includes(gear.id)) {
                    // Assign to this event
                    if (gear.assignedTo !== eventId) {
                        await firestoreHelpers.updateDoc('gear', gear.id, { assignedTo: eventId, status: 'in-use' });
                    }
                    totalValue += gear.value;
                } else if (gear.assignedTo === eventId) {
                    // Unassign from this event
                    await firestoreHelpers.updateDoc('gear', gear.id, { assignedTo: null, status: 'available' });
                }
            }
            
            // Update event gear value
            await firestoreHelpers.updateDoc('events', eventId, { gearValue: totalValue });
            
            closeEventModal();
            await loadData();
        }
        
        function addNote() {
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-sticky-note mr-2 commotion-red"></i>Add Note</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAddNote(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Note</label>
                            <textarea id="noteText" rows="4" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Add a note about this event..."></textarea>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="addNoteBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Add Note</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAddNote(e) {
            e.preventDefault();
            const btn = document.getElementById('addNoteBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            const newNote = {
                text: document.getElementById('noteText').value,
                author: userName,
                date: new Date().toISOString()
            };
            
            const notes = [...(eventData.eventNotes || []), newNote];
            
            const result = await firestoreHelpers.updateDoc('events', eventId, { eventNotes: notes });
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error adding note: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Add Note';
            }
        }
        
        async function deleteNote(index) {
            const notes = eventData.eventNotes.filter((_, i) => i !== index);
            const result = await firestoreHelpers.updateDoc('events', eventId, { eventNotes: notes });
            
            if (result.success) {
                await loadData();
            } else {
                alert('Error deleting note: ' + result.error);
            }
        }
        
        function addTask() {
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            const assignedCrew = eventData.crewAssigned || [];
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-tasks mr-2 commotion-red"></i>Add Task</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleAddTask(event)" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                            <input type="text" id="taskTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="e.g., Edit highlight reel">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description (optional)</label>
                            <textarea id="taskDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Additional details..."></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Assign To</label>
                                <select id="taskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">-- Unassigned --</option>
                                    ${crewData.filter(c => assignedCrew.includes(c.id)).map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                <input type="date" id="taskDueDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                            <select id="taskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="normal">Normal</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="addTaskBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Add Task</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleAddTask(e) {
            e.preventDefault();
            const btn = document.getElementById('addTaskBtn');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            const newTask = {
                id: 'task-' + Date.now(),
                eventId: eventId,
                title: document.getElementById('taskTitle').value,
                description: document.getElementById('taskDescription').value,
                assignedTo: document.getElementById('taskAssignee').value || null,
                dueDate: document.getElementById('taskDueDate').value,
                priority: document.getElementById('taskPriority').value,
                status: 'todo',
                createdAt: new Date().toISOString()
            };
            
            const result = await firestoreHelpers.setDoc('tasks', newTask.id, newTask, false);
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error adding task: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Add Task';
            }
        }
        
        function editTask(taskId) {
            const task = tasksData.find(t => t.id === taskId);
            if (!task) return;
            
            const modal = document.getElementById('eventModal');
            const content = document.getElementById('eventModalContent');
            const assignedCrew = eventData.crewAssigned || [];
            
            content.innerHTML = `
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-900"><i class="fas fa-tasks mr-2 commotion-red"></i>Edit Task</h2>
                        <button onclick="closeEventModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                    </div>
                    <form onsubmit="handleEditTask(event, '${taskId}')" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Task Title</label>
                            <input type="text" id="editTaskTitle" value="${task.title}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <textarea id="editTaskDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg">${task.description || ''}</textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Assign To</label>
                                <select id="editTaskAssignee" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">-- Unassigned --</option>
                                    ${crewData.filter(c => assignedCrew.includes(c.id)).map(c => `<option value="${c.id}" ${task.assignedTo === c.id ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                                <input type="date" id="editTaskDueDate" value="${task.dueDate}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="editTaskStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="todo" ${task.status === 'todo' ? 'selected' : ''}>To Do</option>
                                    <option value="in-progress" ${task.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                    <option value="done" ${task.status === 'done' ? 'selected' : ''}>Done</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                <select id="editTaskPriority" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="normal" ${task.priority === 'normal' ? 'selected' : ''}>Normal</option>
                                    <option value="high" ${task.priority === 'high' ? 'selected' : ''}>High</option>
                                    <option value="urgent" ${task.priority === 'urgent' ? 'selected' : ''}>Urgent</option>
                                </select>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-4">
                            <button type="submit" id="editTaskBtn" class="flex-1 px-4 py-3 bg-commotion-red text-white rounded-lg font-semibold">Save Changes</button>
                            <button type="button" onclick="deleteTask('${taskId}')" class="px-4 py-3 bg-red-100 text-red-700 hover:bg-red-200 rounded-lg font-semibold">Delete</button>
                            <button type="button" onclick="closeEventModal()" class="px-4 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg font-semibold">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function handleEditTask(e, taskId) {
            e.preventDefault();
            const btn = document.getElementById('editTaskBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';
            
            const updates = {
                title: document.getElementById('editTaskTitle').value,
                description: document.getElementById('editTaskDescription').value,
                assignedTo: document.getElementById('editTaskAssignee').value || null,
                dueDate: document.getElementById('editTaskDueDate').value,
                status: document.getElementById('editTaskStatus').value,
                priority: document.getElementById('editTaskPriority').value
            };
            
            const result = await firestoreHelpers.updateDoc('tasks', taskId, updates);
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error updating task: ' + result.error);
                btn.disabled = false;
                btn.textContent = 'Save Changes';
            }
        }
        
        async function deleteTask(taskId) {
            const result = await firestoreHelpers.deleteDoc('tasks', taskId);
            
            if (result.success) {
                closeEventModal();
                await loadData();
            } else {
                alert('Error deleting task: ' + result.error);
            }
        }
        
        async function deleteEvent() {
            if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) return;
            
            const result = await firestoreHelpers.deleteDoc('events', eventId);
            
            if (result.success) {
                // Also delete associated tasks
                for (const task of tasksData) {
                    await firestoreHelpers.deleteDoc('tasks', task.id);
                }
                alert('Event deleted successfully');
                window.location.href = 'dashboard.html';
            } else {
                alert('Error deleting event: ' + result.error);
            }
        }
        
        function renderPaymentsTab() {
            // Calculate crew costs for this event
            const eventDays = Math.ceil((new Date(eventData.endDate) - new Date(eventData.startDate)) / (1000 * 60 * 60 * 24)) + 1;
            const assignedCrew = eventData.crewAssigned || [];
            
            let crewPayments = assignedCrew.map(crewId => {
                const crew = crewData.find(c => c.id === crewId);
                if (!crew) return null;
                const amount = crew.rate * eventDays;
                // Check if this crew has been marked paid for this event
                const crewEventPayments = crew.eventPayments || {};
                const isPaid = crewEventPayments[eventId] === true;
                return { crew, amount, isPaid };
            }).filter(Boolean);
            
            const totalCrewCost = crewPayments.reduce((sum, cp) => sum + cp.amount, 0);
            const totalPaid = crewPayments.filter(cp => cp.isPaid).reduce((sum, cp) => sum + cp.amount, 0);
            
            return `
                <div class="space-y-6">
                    <!-- Summary -->
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded-lg">
                            <p class="text-xl font-bold text-blue-600">$${eventData.quoteAmount.toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Event Quote</p>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded-lg">
                            <p class="text-xl font-bold text-green-600">$${eventData.paidAmount.toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Client Paid</p>
                        </div>
                        <div class="text-center p-4 bg-red-50 rounded-lg">
                            <p class="text-xl font-bold commotion-red">$${totalCrewCost.toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Crew Costs</p>
                        </div>
                        <div class="text-center p-4 bg-gray-100 rounded-lg">
                            <p class="text-xl font-bold ${eventData.paidAmount - totalPaid >= 0 ? 'text-green-600' : 'commotion-red'}">$${(eventData.paidAmount - totalPaid).toLocaleString()}</p>
                            <p class="text-xs text-gray-600">Net After Crew</p>
                        </div>
                    </div>
                    
                    <!-- Crew Payments -->
                    <div>
                        <h3 class="font-semibold text-gray-900 mb-4"><i class="fas fa-users mr-2 commotion-red"></i>Crew Payment Status</h3>
                        <div class="space-y-3">
                            ${crewPayments.map(cp => `
                                <div class="flex items-center justify-between p-4 bg-white border border-gray-200 rounded-lg">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-full bg-commotion-red text-white flex items-center justify-center font-bold mr-3">${cp.crew.name.split(' ').map(n => n[0]).join('')}</div>
                                        <div>
                                            <p class="font-semibold text-gray-900">${cp.crew.name}</p>
                                            <p class="text-xs text-gray-500">${eventDays} days Ã— $${cp.crew.rate}/day</p>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <span class="font-bold text-lg">$${cp.amount.toLocaleString()}</span>
                                        <button onclick="toggleCrewPayment('${cp.crew.id}', ${!cp.isPaid})" class="px-4 py-2 rounded-lg font-semibold text-sm ${cp.isPaid ? 'bg-green-100 text-green-700' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                                            <i class="fas ${cp.isPaid ? 'fa-check-circle' : 'fa-circle'} mr-2"></i>${cp.isPaid ? 'Paid' : 'Mark Paid'}
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    ${crewPayments.length === 0 ? '<p class="text-center text-gray-500 py-8">No crew assigned to this event</p>' : ''}
                </div>
            `;
        }
        
        async function toggleCrewPayment(crewId, isPaid) {
            const crew = crewData.find(c => c.id === crewId);
            if (!crew) return;
            
            const eventPayments = crew.eventPayments || {};
            eventPayments[eventId] = isPaid;
            
            // Also update total paid amount
            let totalPaid = 0;
            const eventDays = Math.ceil((new Date(eventData.endDate) - new Date(eventData.startDate)) / (1000 * 60 * 60 * 24)) + 1;
            
            // Recalculate total paid across all events
            for (const [evtId, paid] of Object.entries(eventPayments)) {
                if (paid) {
                    const evt = await firestoreHelpers.getDoc('events', evtId);
                    if (evt) {
                        const days = Math.ceil((new Date(evt.endDate) - new Date(evt.startDate)) / (1000 * 60 * 60 * 24)) + 1;
                        totalPaid += crew.rate * days;
                    }
                }
            }
            
            await firestoreHelpers.updateDoc('crew', crewId, { 
                eventPayments: eventPayments,
                paidAmount: totalPaid
            });
            
            await loadData();
        }
        
        function closeEventModal() { document.getElementById('eventModal').classList.add('hidden'); document.getElementById('eventModal').classList.remove('flex'); }

        // Utility functions
        function getStatusLabel(status) {
            const labels = {'confirmed': 'Confirmed', 'quote-sent': 'Quote Sent', 'in-progress': 'In Progress', 'completed': 'Completed', 'lead': 'Lead', 'pending': 'Pending'};
            return labels[status] || status;
        }
        
        function getStatusBadgeClass(status) {
            const classes = {'confirmed': 'bg-green-100 text-green-700', 'quote-sent': 'bg-yellow-100 text-yellow-700', 'in-progress': 'bg-blue-100 text-blue-700', 'completed': 'bg-gray-100 text-gray-700', 'lead': 'bg-gray-100 text-gray-700', 'pending': 'bg-gray-100 text-gray-700'};
            return classes[status] || 'bg-gray-100 text-gray-700';
        }
        
        function formatDateRange(start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            if (start === end) return startDate.toLocaleDateString('en-NZ', {month: 'short', day: 'numeric', year: 'numeric'});
            return `${startDate.toLocaleDateString('en-NZ', {month: 'short', day: 'numeric'})} - ${endDate.toLocaleDateString('en-NZ', {month: 'short', day: 'numeric', year: 'numeric'})}`;
        }

        function logout() {
            signOut().then(() => {
                localStorage.clear();
                window.location.href = 'index.html';
            });
        }
    </script>

</body>
</html>
